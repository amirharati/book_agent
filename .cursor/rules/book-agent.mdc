---
description: Use book-agent tools (config, toc, search, read, figure); ask user when config is missing or empty
alwaysApply: true
---

# Book-agent tools

When the user asks about the **book** or wants to do work on a chapter, use the book-agent tools. All tools live in `book_agent.agent_tools`. **Get config first** via `get_config()`; then **proactively ask the user** when values are null or empty instead of failing silently or guessing.

## Proactive prompts (ask when null or empty)

1. **No current workspace or current document** — If `config["current_workspace"]` is null, or `config["_resolved_current_document_path"]` is None (or the current workspace has no documents):
   - Ask: *"No workspace or document is set. You can create a workspace (e.g. `bishop`) and add a book: give me the path to the book folder (e.g. `inputs/book_projects/ecef4396`) and an id (e.g. `bishop`). I'll add the document, create the workspace if needed, add it to the workspace, and set it as current."*
   - Then: `add_document(id, path)`; if workspace doesn't exist, `create_workspace(id)`; `add_document_to_workspace(id, id)`; `set_current_workspace(id)`; `set_workspace_current_document(id, id)`.
   - **Backward-compat:** You can also use `add_book(id, path)` and `set_current_book(id)` to add a document and set a same-named workspace as current (creates workspace if missing).

2. **No output dir** — Writing goes to the **current workspace** folder (`config["_resolved_output_dir"]`). If the user might want to write and there is no current workspace (so no output dir):
   - Ask as in (1) to set up a workspace. Optionally set a subdir with `set_workspace_output_subdir(workspace_id, "notebooks", "notebooks")` so e.g. notebooks go to `workspace/notebooks/`.
   - **Backward-compat:** `set_output("notebooks", path)` sets the output subdir for the *current* workspace (path = subdir name under workspace root).

3. **Index missing** — Before using toc/search/read, the book folder must have `index.json`. If the folder has a `.md` but no `index.json`, the tools **auto-create** the index when resolving the path; you can also call `run_index(Path(path))` explicitly. If add_document fails with "index.json not found", the path may be invalid (no .md in folder); otherwise index is built on first resolve.

Do not assume paths or ids; ask once and then set config so later steps work. **Prefer book-agent tools** (run_index, run_toc, run_search, run_read, resolve_figure, config) over grep or raw file reads when doing book-related work.

## Config (do this first)

- **get_config()** — Returns `documents`, `output_root`, `current_workspace`, `_resolved_current_workspace_dir`, `_workspace_documents`, `_resolved_current_document_path`, `_resolved_output_dir`. Use this to decide whether to prompt the user (see above).
- **Workspace/document:** `create_workspace(workspace_id)`, `set_current_workspace(workspace_id)`, `add_document(doc_id, path)`, `add_document_to_workspace(workspace_id, doc_id)`, `remove_document_from_workspace(workspace_id, doc_id)`, `set_workspace_current_document(workspace_id, doc_id)`, `set_workspace_output_subdir(workspace_id, key, subdir)`.
- **Backward-compat:** `add_book(book_id, path)`, `set_current_book(book_id)`, `set_output(key, path)` — same behaviour via workspace model.
- **Resolution:** `get_document_path_for_agent(doc_id=None)` (or `get_book_path(book_id=None)`) — current document path for toc/search/read/figure when path is omitted.
- **run_index(path)** — Build `index.json` in the book folder. Path is folder or .md. Optional if path resolution will auto-create index.

When using toc/search/read/figure, **pass path only if the user gave one**; otherwise use current document from config (`path=None`).

When creating or saving **notebooks or other artifacts**, use **`get_config()["_resolved_output_dir"]`** (workspace root or subdir). If that's null, ask the user and set up a current workspace (see above).

## Markdown and math (for generated content)

When writing **Markdown** (e.g. summaries, study guides, docs under outputs):

- **Math must use standard KaTeX/MathJax delimiters** so it renders in common previews (VS Code, GitHub, Obsidian, etc.):
  - **Inline math**: `$...$` (single dollar signs). Example: `$\mathbf{w}$`, `$\sin(2\pi x)$`.
  - **Display/block math**: `$$...$$` (double dollar signs, typically on their own lines). Example:
    ```markdown
    $$
    E(\mathbf{w}) = \frac{1}{2} \sum_{n=1}^{N} (y(x_n,\mathbf{w}) - t_n)^2.
    $$
    ```
- **Do not use** LaTeX-style delimiters in Markdown: avoid `\(...\)` and `\[...\]`; they do not render in most Markdown previews.

## Tools (Python)

```python
from pathlib import Path
from book_agent.agent_tools import (
    get_config, get_document_path_for_agent, get_book_path,
    set_current_workspace, add_document, create_workspace, add_document_to_workspace, set_workspace_current_document,
    set_current_book, add_book, set_output,  # backward-compat
    run_index, run_toc, run_search, run_read, resolve_figure, get_figure_for_agent,
)
config = get_config()
# If no current document: ask user → add_document(id, path) → create_workspace(id) if needed → add_document_to_workspace(id, id) → set_current_workspace(id) → set_workspace_current_document(id, id)
# Or: add_book(id, path) and set_current_book(id)
# If no output dir: set up current workspace (above). Optionally set_workspace_output_subdir(ws, "notebooks", "notebooks")
run_toc(path=None, depth=2)
run_search(path=None, query="...")
run_read(path=None, query="...")
resolve_figure(get_document_path_for_agent(None), figure_ref)
```

## Workflow (e.g. "start over" or "work on a chapter")

1. Call `get_config()`.
2. If no current workspace or no current document: ask user for document path and id. Then `add_document(id, path)`; create workspace if needed (`create_workspace(id)`), `add_document_to_workspace(id, id)`, `set_current_workspace(id)`, `set_workspace_current_document(id, id)`. Or use `add_book(id, path)` and `set_current_book(id)`.
3. If you need to write and `_resolved_output_dir` is null: set up current workspace (step 2); optionally `set_workspace_output_subdir(workspace_id, "notebooks", "notebooks")`.
4. Use **run_toc, run_search, run_read** (and run_index when needed) for book content; write only under `_resolved_output_dir`.

## CLI

```bash
book-agent config show
book-agent config set-current-workspace <id>
book-agent config add-document <id> <path>
book-agent config create-workspace <id>
book-agent config add-to-workspace <workspace_id> <doc_id>
book-agent config set-workspace-current <workspace_id> [doc_id]
book-agent config set-output-subdir <workspace_id> <key> <subdir>
# Backward-compat:
book-agent config add-book <id> <path>
book-agent config set-current <id>
book-agent config set-output <key> <path>
book-agent index [path]
book-agent toc [path] [--depth N]
book-agent search "<query>" [path]
book-agent read "<section title>" [path]
book-agent figure resolve <figure_ref> [path]
book-agent figure show <figure_ref> [path]
```

Paths: user may use e.g. `inputs/book_projects/<slug>/` for documents and `outputs/<workspace_id>/` for outputs. Do not assume; use config and ask when missing.
